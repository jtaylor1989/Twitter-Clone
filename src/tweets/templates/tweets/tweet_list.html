{% extends "base.html" %}

{% block title %} {{ block.super }} Tweets {% endblock title %}

{% block script %}
<script type="text/javascript">

  function getParameterByName(name, url) {
    /**
    a stackoverflow thread that shows how to
    handle the query search parameter in our ajax
    call function
    **/
    if (!url) {
      url = window.location.href;
    }
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
  }

  $(document).ready(function(){
    var query = getParameterByName('q');
    var tweetList = [];

    function attachTweet(tweetValue, prepend){
      // appends the new tweet to the tweets list
      var tweetContent = tweetValue.content;
      var tweetUser = tweetValue.user;
      var dateDisplay = tweetValue.date_display;

      var tweetFormattedHTML = "<div class=\"media\"><div class=\"media-body\">"
                                + tweetContent + "<br/> via "
                                + tweetUser.username
                                + " | " + dateDisplay + " | "
                                + "<a href='#'>View</a>"
                                + "</div></div><hr/>";

      if (prepend==true) {
        $("#tweet-container").prepend(tweetFormattedHTML);
      } else {
        $("#tweet-container").append(tweetFormattedHTML);
      }
    }

    function parseTweets(){
      if (tweetList == 0) {
        $("#tweet-container").text("No tweets currently found.")
      } else {
        // tweets exist, parse & display them
       $.each(tweetList, function(key, value){
         attachTweet(value);

        })
      }
    }

    /**
    making an ajax call every time the page is loaded
    or a new tweet is submitted
    **/
    function fetchTweets(){
      $.ajax({
        url: '/api/tweets/',
        data: {
          'q': query // gets appended to the above url
        },
        method: 'GET',
        success: function(data){
          tweetList = data;
          parseTweets();
        },
        error: function(data){
          console.log('error');
          console.log(data);
        }
      });
    }

    fetchTweets();

    // ajax form tweet submission
    $('#tweet-form').submit(function(event){
      event.preventDefault();
      var this_ = $(this)
      var formData = this_.serialize();  // outputs json data

      $.ajax({
        url: '/api/tweets/create/',
        data: formData,
        method: 'POST',
        success: function(data){
          attachTweet(data, true); // attaches the new tweet
          // empty the form after sumbission
          this_.find('input[type=text], textarea').val('');
        },
        error: function(data){
          console.log('error');
        }
      });

    })

  });


</script>

{% endblock script %}


{% block content %}

<div class='row'>
  <div class='col-sm-3 col-xs-12' style='background-color:red;'>
    <h1>{{ request.user }}</h1>
  </div>
  <div class='col-sm-9 '>
    {% if not request.GET.q %}
      <div>
        {% include "tweets/form.html" with form=create_form action_url=create_url btn_title='Tweet' form_id='tweet-form' %}
      </div>
      <hr/>
    {% endif %}

    <div id='tweet-container'>
    </div>

  </div>
</div>


{% endblock content %}
